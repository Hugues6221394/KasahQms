@page
@model KasahQMS.Web.Pages.Analytics.IndexModel
@{
    ViewData["Title"] = "Analytics";
}

<div class="space-y-8">
    <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
        <div>
            <h1 class="text-2xl font-semibold text-slate-900">Executive analytics</h1>
            <p class="text-sm text-slate-500">Performance indicators for TMD and departmental managers.</p>
        </div>
        <div class="flex gap-3">
            <button class="rounded-lg border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-700">Export PDF</button>
            <button class="rounded-lg bg-brand-600 px-4 py-2 text-sm font-semibold text-white hover:bg-brand-700">Share snapshot</button>
        </div>
    </div>

    <div class="grid gap-5 md:grid-cols-2 xl:grid-cols-4">
        @foreach (var kpi in Model.Kpis)
        {
            <div class="card p-5">
                <div class="text-xs uppercase tracking-wide text-slate-500">@kpi.Label</div>
                <div class="mt-3 text-2xl font-semibold text-slate-900">@kpi.Value</div>
                <div class="mt-2 text-xs text-slate-500">@kpi.Note</div>
            </div>
        }
    </div>

    <div class="grid gap-6 xl:grid-cols-3">
        <div class="card p-6 xl:col-span-2">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-slate-900">Compliance trend</h2>
                <span class="text-xs text-slate-500">Year to date</span>
            </div>
            <div class="mt-4">
                <canvas id="complianceTrendChart" height="120"></canvas>
            </div>
        </div>
        <div class="card p-6">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-slate-900">Audit findings</h2>
                <span class="text-xs text-slate-500">Severity mix</span>
            </div>
            <div class="mt-4">
                <canvas id="findingSeverityChart" height="220"></canvas>
            </div>
        </div>
    </div>

    <div class="card p-6">
        <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold text-slate-900">Department performance</h2>
            <span class="text-xs text-slate-500">Quarterly status</span>
        </div>
        <div class="mt-4 overflow-hidden rounded-lg border border-slate-200">
            <table class="min-w-full divide-y divide-slate-200 text-sm">
                <thead class="bg-slate-50 text-slate-500 uppercase text-xs">
                    <tr>
                        <th class="px-4 py-3 text-left font-semibold">Department</th>
                        <th class="px-4 py-3 text-left font-semibold">Compliance</th>
                        <th class="px-4 py-3 text-left font-semibold">Open CAPAs</th>
                        <th class="px-4 py-3 text-left font-semibold">Audit readiness</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100 bg-white">
                    @foreach (var dept in Model.DepartmentMetrics)
                    {
                        <tr>
                            <td class="px-4 py-3 font-semibold text-slate-800">@dept.Department</td>
                            <td class="px-4 py-3 text-slate-600">@dept.Compliance</td>
                            <td class="px-4 py-3 text-slate-600">@dept.OpenCapa</td>
                            <td class="px-4 py-3 text-slate-600">@dept.Readiness</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const complianceTrend = @Html.Raw(Model.ComplianceTrendJson);
        const findings = @Html.Raw(Model.FindingSeverityJson);

        const complianceCtx = document.getElementById('complianceTrendChart');
        if (complianceCtx) {
            new Chart(complianceCtx, {
                type: 'line',
                data: {
                    labels: complianceTrend.labels,
                    datasets: [{
                        label: 'Compliance %',
                        data: complianceTrend.values,
                        borderColor: '#22c55e',
                        backgroundColor: 'rgba(34, 197, 94, 0.15)',
                        tension: 0.35,
                        fill: true
                    }]
                },
                options: {
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { grid: { color: '#e2e8f0' }, ticks: { color: '#64748b' } },
                        x: { grid: { display: false }, ticks: { color: '#64748b' } }
                    }
                }
            });
        }

        const severityCtx = document.getElementById('findingSeverityChart');
        if (severityCtx) {
            new Chart(severityCtx, {
                type: 'polarArea',
                data: {
                    labels: findings.labels,
                    datasets: [{
                        data: findings.values,
                        backgroundColor: ['#16a34a', '#4ade80', '#f59e0b', '#ef4444']
                    }]
                },
                options: { plugins: { legend: { position: 'bottom' } } }
            });
        }
    </script>
}


