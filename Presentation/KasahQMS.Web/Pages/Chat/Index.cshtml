@page
@model KasahQMS.Web.Pages.Chat.IndexModel
@{
    ViewData["Title"] = "Messages";
}

@functions {
    string GetTimeAgo(DateTime time)
    {
        var diff = DateTime.UtcNow - time;
        if (diff.TotalMinutes < 1) return "now";
        if (diff.TotalMinutes < 60) return $"{(int)diff.TotalMinutes}m";
        if (diff.TotalHours < 24) return $"{(int)diff.TotalHours}h";
        if (diff.TotalDays < 2) return "Yesterday";
        if (diff.TotalDays < 7) return $"{(int)diff.TotalDays}d";
        return time.ToString("MMM d");
    }
}

<div class="h-[calc(100vh-180px)] flex flex-col">
    <!-- Header -->
    <div class="flex items-center justify-between mb-4">
        <div>
            <h1 class="text-2xl font-bold text-slate-900">Messages</h1>
            <p class="text-sm text-slate-500">Communicate with colleagues, teams, and departments</p>
        </div>
    </div>

    <div class="flex-1 flex gap-4 min-h-0">
        <!-- Sidebar - Conversations (Instagram-style inbox) -->
        <div class="w-80 flex-shrink-0 bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col">
            <!-- Header with New Conversation -->
            <div class="p-4 border-b border-slate-200 flex items-center justify-between">
                <h2 class="font-semibold text-slate-800">Inbox</h2>
                <button type="button" id="btn-new-chat" class="p-2 text-brand-600 hover:bg-brand-50 rounded-lg transition-colors" title="New Conversation">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                </button>
            </div>
            
            <!-- Search -->
            <div class="px-3 py-2 border-b border-slate-100">
                <div class="relative">
                    <input type="text" id="search-conversations" placeholder="Search messages" 
                           class="w-full pl-9 pr-4 py-2 text-sm bg-slate-100 border-0 rounded-lg focus:bg-white focus:ring-2 focus:ring-brand-200 transition-all">
                    <svg class="absolute left-3 top-2.5 w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                </div>
            </div>
            
            <!-- Conversation List -->
            <div class="flex-1 overflow-y-auto" id="conversation-list">
                @if (Model.Conversations.Any())
                {
                    <!-- Existing Conversations (sorted by most recent) -->
                    @foreach (var conv in Model.Conversations)
                    {
                        var bgColor = conv.Type == "Department" ? "bg-brand-100 text-brand-600" : "bg-slate-100 text-slate-600";
                        var timeAgo = GetTimeAgo(conv.LastMessageTime);
                        
                        <button type="button" 
                                class="conv-btn w-full text-left px-4 py-3 hover:bg-slate-50 border-b border-slate-100 transition-all @(conv.HasUnread ? "bg-brand-50/50" : "")"
                                data-mode="@(conv.Type == "Department" ? "department" : "direct")" 
                                data-id="@(conv.Type == "Department" ? conv.ThreadId : conv.OtherUserId)" 
                                data-thread-id="@conv.ThreadId"
                                data-name="@conv.Name">
                            <div class="flex items-center gap-3">
                                <div class="relative">
                                    <div class="w-12 h-12 rounded-full @bgColor flex items-center justify-center flex-shrink-0 text-sm font-semibold">
                                        @if (conv.Type == "Department")
                                        {
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                                        }
                                        else
                                        {
                                            @conv.AvatarInitials
                                        }
                                    </div>
                                    @if (conv.HasUnread)
                                    {
                                        <span class="absolute -top-0.5 -right-0.5 w-3 h-3 bg-brand-500 rounded-full border-2 border-white"></span>
                                    }
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center justify-between gap-2">
                                        <span class="font-medium text-slate-900 truncate @(conv.HasUnread ? "font-semibold" : "")">@conv.Name</span>
                                        <span class="text-xs text-slate-400 flex-shrink-0">@timeAgo</span>
                                    </div>
                                    <div class="flex items-center gap-1 mt-0.5">
                                        @if (conv.HasAttachment)
                                        {
                                            <svg class="w-3.5 h-3.5 text-slate-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/></svg>
                                        }
                                        <p class="text-sm text-slate-500 truncate @(conv.HasUnread ? "text-slate-700 font-medium" : "")">@conv.LastMessagePreview</p>
                                    </div>
                                </div>
                            </div>
                        </button>
                    }
    }
    else
    {
                    <!-- Empty state -->
                    <div class="flex flex-col items-center justify-center h-64 text-center px-6">
                        <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-4">
                            <svg class="w-8 h-8 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                        </div>
                        <p class="text-slate-600 font-medium">No messages yet</p>
                        <p class="text-sm text-slate-400 mt-1">Start a conversation with someone</p>
                        <button type="button" onclick="document.getElementById('btn-new-chat').click()" class="mt-4 px-4 py-2 bg-brand-600 text-white text-sm font-medium rounded-lg hover:bg-brand-700">
                            Start Chatting
                        </button>
                    </div>
                }
            </div>
        </div>

        <!-- Chat Window -->
        <div class="flex-1 bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col min-w-0">
            <!-- Chat Header -->
            <div class="px-6 py-4 border-b border-slate-200 flex items-center justify-between" id="chat-header">
                <div class="flex items-center gap-3">
                    <div id="chat-avatar" class="w-10 h-10 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                    </div>
                    <div>
                        <div id="chat-title" class="font-semibold text-slate-900">Select a conversation</div>
                        <div id="chat-subtitle" class="text-sm text-slate-500">Choose from the sidebar to start chatting</div>
                    </div>
                </div>
            </div>

            <!-- Messages Area -->
            <div id="chat-messages" class="flex-1 overflow-y-auto p-6 space-y-4 bg-slate-50/50">
                <div class="flex flex-col items-center justify-center h-full text-center text-slate-400">
                    <svg class="w-16 h-16 mb-4 text-slate-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                    </svg>
                    <p class="text-lg font-medium">No conversation selected</p>
                    <p class="text-sm">Select a contact or department from the sidebar</p>
                </div>
            </div>

            <!-- Message Input -->
            <div class="p-4 border-t border-slate-200 bg-white" id="chat-input-area" style="display: none;">
                <form id="chat-form" class="flex flex-col gap-3">
                    <input type="hidden" id="chat-mode" value="">
                    <input type="hidden" id="chat-target-id" value="">
                    <input type="hidden" id="edit-message-id" value="">
                    
                    <!-- File Preview -->
                    <div id="file-preview" class="hidden p-3 bg-slate-100 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/></svg>
                                <span id="file-name" class="text-sm text-slate-700"></span>
                            </div>
                            <button type="button" id="remove-file" class="text-slate-400 hover:text-red-500">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex items-end gap-2">
                        <!-- Attachment Button -->
                        <label class="p-3 text-slate-500 hover:text-brand-600 hover:bg-slate-100 rounded-lg cursor-pointer transition-colors" title="Attach file">
                            <input type="file" id="file-input" class="hidden" accept=".pdf,.doc,.docx,.xls,.xlsx,.txt,.png,.jpg,.jpeg,.gif">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/></svg>
                        </label>
                        
                        <!-- Message Input -->
                        <div class="flex-1 relative">
                            <textarea id="chat-input" rows="1" placeholder="Type a message..." autocomplete="off"
                                class="w-full rounded-xl border border-slate-300 px-4 py-3 pr-12 resize-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500 text-sm"
                                style="min-height: 48px; max-height: 120px;"></textarea>
                        </div>
                        
                        <!-- Send Button -->
                        <button type="submit" id="chat-send" class="p-3 bg-brand-600 text-white rounded-xl hover:bg-brand-700 transition-colors" title="Send message">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                        </button>
                    </div>
                    
                    <!-- Edit Mode Indicator -->
                    <div id="edit-mode-bar" class="hidden flex items-center justify-between px-3 py-2 bg-amber-50 border border-amber-200 rounded-lg text-sm">
                        <span class="text-amber-700">Editing message...</span>
                        <button type="button" id="cancel-edit" class="text-amber-600 hover:text-amber-800 font-medium">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- New Chat Modal -->
<div id="new-chat-modal" class="fixed inset-0 z-50 hidden" aria-hidden="true">
    <div class="fixed inset-0 bg-black/50" id="modal-backdrop"></div>
    <div class="fixed inset-0 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl max-w-md w-full max-h-[90vh] overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-200 flex items-center justify-between">
                <h2 class="text-lg font-semibold text-slate-900">New Conversation</h2>
                <button type="button" id="close-modal" class="text-slate-400 hover:text-slate-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Search Contacts</label>
                    <input type="text" id="search-contacts" placeholder="Type a name..." class="w-full rounded-lg border border-slate-300 px-4 py-2 focus:ring-2 focus:ring-brand-500 focus:border-brand-500">
                </div>
                <div class="max-h-64 overflow-y-auto space-y-1" id="modal-contacts-list">
                    @foreach (var user in Model.AllUsers)
                    {
                        <button type="button" class="modal-contact-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-50 transition-colors"
                                data-id="@user.Id" data-name="@user.Name">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-brand-100 text-brand-600 flex items-center justify-center font-semibold">
                                    @user.Name.Substring(0, 1).ToUpper()
                                </div>
                                <div>
                                    <div class="font-medium text-slate-900">@user.Name</div>
                                    <div class="text-sm text-slate-500">@user.Department</div>
                                </div>
                            </div>
                        </button>
                    }
                </div>
                @if (Model.IsManager)
                {
                    <div class="pt-4 border-t border-slate-200">
                        <label class="block text-sm font-medium text-slate-700 mb-2">Or message a department</label>
                        <select id="modal-dept-select" class="w-full rounded-lg border border-slate-300 px-4 py-2 focus:ring-2 focus:ring-brand-500 focus:border-brand-500">
                            <option value="">Select department...</option>
                            @foreach (var dept in Model.Departments)
                            {
                                <option value="@dept.Id" data-name="@dept.Name">@dept.Name</option>
                            }
                        </select>
                        <button type="button" id="modal-start-dept-chat" class="mt-2 w-full px-4 py-2 bg-slate-600 text-white text-sm font-medium rounded-lg hover:bg-slate-700 disabled:opacity-50" disabled>
                            Start Department Chat
                        </button>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Message Context Menu -->
<div id="message-context-menu" class="fixed z-50 hidden bg-white rounded-lg shadow-lg border border-slate-200 py-1 min-w-[160px]">
    <button type="button" id="ctx-edit" class="w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 flex items-center gap-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
        Edit
    </button>
    <button type="button" id="ctx-delete" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 flex items-center gap-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
        Delete
    </button>
</div>

@section Scripts {
    <script src="~/js/signalr-chat.js"></script>
    <script>
        (function() {
        'use strict';
        
        var currentUserId = '@(Model.CurrentUserId?.ToString() ?? "")';
        var currentUserName = '@Model.CurrentUserName';
        var myOrgUnitId = '@(Model.OrgUnitId?.ToString() ?? "")';
        
        // Auto-open parameters from notification
        var autoOpenThreadId = '@(Model.OpenThreadId?.ToString() ?? "")';
        var autoOpenUserId = '@(Model.OpenUserId?.ToString() ?? "")';
        var autoOpenUserName = '@(Model.OpenUserName ?? "")';
        var autoOpenThreadType = '@(Model.OpenThreadType ?? "")';

            var messagesEl = document.getElementById('chat-messages');
        var chatTitle = document.getElementById('chat-title');
        var chatSubtitle = document.getElementById('chat-subtitle');
        var chatAvatar = document.getElementById('chat-avatar');
        var chatInputArea = document.getElementById('chat-input-area');
        var chatForm = document.getElementById('chat-form');
        var chatInput = document.getElementById('chat-input');
        var chatModeEl = document.getElementById('chat-mode');
        var chatTargetIdEl = document.getElementById('chat-target-id');
        var editMessageIdEl = document.getElementById('edit-message-id');
        var editModeBar = document.getElementById('edit-mode-bar');
        var cancelEditBtn = document.getElementById('cancel-edit');
        var fileInput = document.getElementById('file-input');
        var filePreview = document.getElementById('file-preview');
        var fileNameEl = document.getElementById('file-name');
        var removeFileBtn = document.getElementById('remove-file');
        
        var newChatModal = document.getElementById('new-chat-modal');
        var contextMenu = document.getElementById('message-context-menu');
        
        var currentThreadId = null;
        var selectedFile = null;
        var contextMessageId = null;
        var contextMessageContent = null;
        
        // Auto-resize textarea
        chatInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
        
        // File handling
        fileInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                selectedFile = this.files[0];
                fileNameEl.textContent = selectedFile.name;
                filePreview.classList.remove('hidden');
            }
        });
        
        removeFileBtn.addEventListener('click', function() {
            selectedFile = null;
            fileInput.value = '';
            filePreview.classList.add('hidden');
        });
        
        function createMessageBubble(msg, isOwn) {
                var div = document.createElement('div');
                div.className = 'flex ' + (isOwn ? 'justify-end' : 'justify-start');
            div.setAttribute('data-message-id', msg.id || '');
            div.setAttribute('data-message-content', msg.content || '');
            
            var wrapper = document.createElement('div');
            wrapper.className = 'max-w-[70%] group';
            
                var bubble = document.createElement('div');
            bubble.className = 'rounded-2xl px-4 py-3 ' + (isOwn ? 'bg-brand-600 text-white rounded-br-md' : 'bg-white border border-slate-200 text-slate-900 shadow-sm rounded-bl-md');
            
            if (!isOwn) {
                var name = document.createElement('div');
                name.className = 'text-xs font-semibold text-brand-600 mb-1';
                name.textContent = msg.senderName || 'Unknown';
                bubble.appendChild(name);
            }
            
            var text = document.createElement('div');
            text.className = 'text-sm whitespace-pre-wrap break-words';
            text.textContent = msg.content || '';
                bubble.appendChild(text);
            
            // Attachment
            if (msg.attachmentPath) {
                var attach = document.createElement('a');
                attach.href = msg.attachmentPath;
                attach.target = '_blank';
                attach.className = 'flex items-center gap-2 mt-2 px-3 py-2 rounded-lg ' + (isOwn ? 'bg-brand-700 text-brand-100' : 'bg-slate-100 text-slate-600') + ' text-xs hover:opacity-80';
                attach.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/></svg>' +
                    '<span>' + (msg.attachmentName || 'Attachment') + '</span>';
                bubble.appendChild(attach);
            }
            
            var time = document.createElement('div');
            time.className = 'text-xs mt-1 ' + (isOwn ? 'text-brand-200' : 'text-slate-400');
            time.textContent = msg.createdAt ? new Date(msg.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
            if (msg.editedAt) {
                time.textContent += ' (edited)';
            }
                bubble.appendChild(time);
            
            wrapper.appendChild(bubble);
            
            // Context menu trigger for own messages
            if (isOwn) {
                var menuBtn = document.createElement('button');
                menuBtn.className = 'opacity-0 group-hover:opacity-100 absolute -left-8 top-1/2 -translate-y-1/2 p-1 text-slate-400 hover:text-slate-600 transition-opacity';
                menuBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"/></svg>';
                menuBtn.onclick = function(e) {
                    e.stopPropagation();
                    showContextMenu(e, msg.id, msg.content);
                };
                wrapper.style.position = 'relative';
                wrapper.appendChild(menuBtn);
            }
            
            div.appendChild(wrapper);
            return div;
        }
        
        function showContextMenu(e, messageId, content) {
            contextMessageId = messageId;
            contextMessageContent = content;
            contextMenu.style.left = e.pageX + 'px';
            contextMenu.style.top = e.pageY + 'px';
            contextMenu.classList.remove('hidden');
        }
        
        document.addEventListener('click', function() {
            contextMenu.classList.add('hidden');
        });
        
        document.getElementById('ctx-edit').addEventListener('click', function() {
            if (contextMessageId && contextMessageContent) {
                editMessageIdEl.value = contextMessageId;
                chatInput.value = contextMessageContent;
                chatInput.focus();
                editModeBar.classList.remove('hidden');
            }
            contextMenu.classList.add('hidden');
        });
        
        document.getElementById('ctx-delete').addEventListener('click', function() {
            if (contextMessageId && confirm('Delete this message?')) {
                deleteMessage(contextMessageId);
            }
            contextMenu.classList.add('hidden');
        });
        
        cancelEditBtn.addEventListener('click', function() {
            editMessageIdEl.value = '';
            chatInput.value = '';
            editModeBar.classList.add('hidden');
        });
        
        function deleteMessage(messageId) {
            fetch('/api/ChatApi/messages/' + messageId, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' }
            }).then(function(r) {
                if (r.ok) {
                    var msgEl = messagesEl.querySelector('[data-message-id="' + messageId + '"]');
                    if (msgEl) msgEl.remove();
                }
            }).catch(function(e) {
                console.error('Failed to delete message', e);
            });
        }
        
        function clearMessages() {
            messagesEl.innerHTML = '';
        }
        
        function showChatUI(title, subtitle, avatarHtml) {
            chatTitle.textContent = title;
            chatSubtitle.textContent = subtitle;
            if (avatarHtml) chatAvatar.innerHTML = avatarHtml;
            chatInputArea.style.display = 'block';
            chatInput.focus();
        }
        
        function scrollToBottom() {
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }
        
        function loadMessages(threadId) {
            if (!threadId) return;
            fetch('/api/ChatApi/messages?threadId=' + threadId + '&skip=0&take=100')
                    .then(function(r) { return r.json(); })
                    .then(function(list) {
                    clearMessages();
                        if (!list || !Array.isArray(list)) return;
                        list.forEach(function(m) {
                        var isOwn = m.senderId && String(m.senderId).toLowerCase() === currentUserId.toLowerCase();
                        var bubble = createMessageBubble(m, isOwn);
                        messagesEl.appendChild(bubble);
                    });
                    scrollToBottom();
                })
                .catch(function(e) { console.error('Failed to load messages', e); });
        }
        
        // Conversation buttons - handle both new and existing conversations
        function bindConversationButtons() {
            document.querySelectorAll('.conv-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var mode = this.getAttribute('data-mode');
                    var id = this.getAttribute('data-id');
                    var name = this.getAttribute('data-name');
                    var existingThreadId = this.getAttribute('data-thread-id');
                    
                    // Highlight active
                    document.querySelectorAll('.conv-btn').forEach(function(b) {
                        b.classList.remove('bg-brand-50', 'border-brand-200');
                        b.classList.add('border-transparent');
                        // Remove unread indicator
                        var dot = b.querySelector('.bg-brand-500');
                        if (dot && dot.classList.contains('w-3')) dot.classList.add('hidden');
                    });
                    this.classList.add('bg-brand-50', 'border-brand-200');
                    this.classList.remove('border-transparent');
                    
                    // Remove unread styling
                    this.classList.remove('bg-brand-50/50');
                    
                    openConversation(mode, id, name, existingThreadId);
                });
            });
        }
        bindConversationButtons();
        
        function openConversation(mode, id, name, existingThreadId) {
            chatModeEl.value = mode;
            chatTargetIdEl.value = id;
            
            var avatarHtml = '<span class="text-lg font-semibold">' + (name ? name.charAt(0).toUpperCase() : '?') + '</span>';
            var subtitle = mode === 'department' ? 'Department conversation' : 'Direct message';
            var avatarClass = mode === 'department' ? 'bg-brand-100 text-brand-600' : 'bg-emerald-100 text-emerald-600';
            chatAvatar.className = 'w-10 h-10 rounded-full flex items-center justify-center ' + avatarClass;
            
            showChatUI(name, subtitle, avatarHtml);
            
            // If we have an existing thread ID, use it directly
            if (existingThreadId) {
                currentThreadId = existingThreadId;
                loadMessages(existingThreadId);
                if (typeof window.qmsChat !== 'undefined') {
                    window.qmsChat.joinThread(existingThreadId);
                }
                return;
            }
            
            var endpoint = mode === 'department' 
                ? '/api/ChatApi/department-thread?orgUnitId=' + id
                : '/api/ChatApi/direct-thread?otherUserId=' + id;
            
            fetch(endpoint)
                .then(function(r) { return r.json(); })
                .then(function(thread) {
                    if (thread && thread.id) {
                        currentThreadId = thread.id;
                        loadMessages(thread.id);
            if (typeof window.qmsChat !== 'undefined') {
                            if (mode === 'department') {
                                window.qmsChat.joinDepartment(id);
                            } else {
                                window.qmsChat.joinThread(thread.id);
                            }
                        }
                        // Refresh conversation list to show the new conversation
                        refreshConversationList();
                    }
                })
                .catch(function(e) { console.error('Failed to get thread', e); });
        }
        
        // Refresh conversation list (like Instagram - newest at top)
        function refreshConversationList() {
            fetch('/api/ChatApi/conversations')
                .then(function(r) { return r.json(); })
                .then(function(conversations) {
                    var list = document.getElementById('conversation-list');
                    if (!list || !conversations) return;
                    
                    // Build new list HTML
                    var html = '';
                    conversations.forEach(function(conv) {
                        var bgColor = conv.type === 'Department' ? 'bg-brand-100 text-brand-600' : 'bg-slate-100 text-slate-600';
                        var timeAgo = formatTimeAgo(new Date(conv.lastMessageTime));
                        var unreadClass = conv.hasUnread ? 'bg-brand-50/50' : '';
                        var fontWeight = conv.hasUnread ? 'font-semibold' : '';
                        var mode = conv.type === 'Department' ? 'department' : 'direct';
                        var targetId = conv.type === 'Department' ? conv.threadId : conv.otherUserId;
                        var activeClass = currentThreadId === conv.threadId ? 'bg-brand-50 border-brand-200' : 'border-transparent';
                        
                        html += '<button type="button" ' +
                            'class="conv-btn w-full text-left px-4 py-3 hover:bg-slate-50 border-b border-slate-100 transition-all ' + unreadClass + ' ' + activeClass + '" ' +
                            'data-mode="' + mode + '" ' +
                            'data-id="' + targetId + '" ' +
                            'data-thread-id="' + conv.threadId + '" ' +
                            'data-name="' + escapeHtml(conv.name) + '">' +
                            '<div class="flex items-center gap-3">' +
                                '<div class="relative">' +
                                    '<div class="w-12 h-12 rounded-full ' + bgColor + ' flex items-center justify-center flex-shrink-0 text-sm font-semibold">';
                        
                        if (conv.type === 'Department') {
                            html += '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>';
                        } else {
                            html += escapeHtml(conv.avatarInitials || '??');
                        }
                        
                        html += '</div>';
                        if (conv.hasUnread) {
                            html += '<span class="absolute -top-0.5 -right-0.5 w-3 h-3 bg-brand-500 rounded-full border-2 border-white"></span>';
                        }
                        html += '</div>' +
                            '<div class="flex-1 min-w-0">' +
                                '<div class="flex items-center justify-between gap-2">' +
                                    '<span class="font-medium text-slate-900 truncate ' + fontWeight + '">' + escapeHtml(conv.name) + '</span>' +
                                    '<span class="text-xs text-slate-400 flex-shrink-0">' + timeAgo + '</span>' +
                                '</div>' +
                                '<div class="flex items-center gap-1 mt-0.5">';
                        
                        if (conv.hasAttachment) {
                            html += '<svg class="w-3.5 h-3.5 text-slate-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/></svg>';
                        }
                        
                        var previewClass = conv.hasUnread ? 'text-slate-700 font-medium' : '';
                        html += '<p class="text-sm text-slate-500 truncate ' + previewClass + '">' + escapeHtml(conv.lastMessagePreview) + '</p>' +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                        '</button>';
                    });
                    
                    // Show empty state if no conversations
                    if (!conversations.length) {
                        html = '<div class="flex flex-col items-center justify-center h-64 text-center px-6">' +
                            '<div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-4">' +
                                '<svg class="w-8 h-8 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>' +
                            '</div>' +
                            '<p class="text-slate-600 font-medium">No messages yet</p>' +
                            '<p class="text-sm text-slate-400 mt-1">Start a conversation with someone</p>' +
                        '</div>';
                    }
                    
                    list.innerHTML = html;
                    bindConversationButtons();
                })
                .catch(function(e) { console.error('Failed to refresh conversations', e); });
        }
        
        function formatTimeAgo(date) {
            var now = new Date();
            var diff = now - date;
            var mins = Math.floor(diff / 60000);
            var hours = Math.floor(diff / 3600000);
            var days = Math.floor(diff / 86400000);
            
            if (mins < 1) return 'now';
            if (mins < 60) return mins + 'm';
            if (hours < 24) return hours + 'h';
            if (days < 2) return 'Yesterday';
            if (days < 7) return days + 'd';
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Search conversations
        var searchInput = document.getElementById('search-conversations');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                var query = this.value.toLowerCase();
                document.querySelectorAll('.conv-btn').forEach(function(btn) {
                    var name = (btn.getAttribute('data-name') || '').toLowerCase();
                    btn.style.display = name.includes(query) ? 'block' : 'none';
                });
            });
        }
        
        // Send message
        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();
            var text = (chatInput.value || '').trim();
            if (!text && !selectedFile) return;
            
            var mode = chatModeEl.value;
            var targetId = chatTargetIdEl.value;
            var editId = editMessageIdEl.value;
            
            // Handle edit
            if (editId) {
                fetch('/api/ChatApi/messages/' + editId, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: text })
                }).then(function(r) {
                    if (r.ok) {
                        loadMessages(currentThreadId);
                        chatInput.value = '';
                        editMessageIdEl.value = '';
                        editModeBar.classList.add('hidden');
                    }
                }).catch(function(e) {
                    console.error('Failed to edit message', e);
                });
                return;
            }
            
            // Handle file upload
            if (selectedFile) {
                var formData = new FormData();
                formData.append('threadId', currentThreadId);
                formData.append('content', text);
                formData.append('file', selectedFile);
                
                fetch('/api/ChatApi/messages/with-file', {
                    method: 'POST',
                    body: formData
                }).then(function(r) { return r.json(); })
                .then(function(msg) {
                    if (msg && msg.id) {
                        var bubble = createMessageBubble(msg, true);
                        messagesEl.appendChild(bubble);
                        scrollToBottom();
                        refreshConversationList(); // Update conversation list
                    }
                    chatInput.value = '';
                    selectedFile = null;
                    fileInput.value = '';
                    filePreview.classList.add('hidden');
                }).catch(function(e) {
                    console.error('Failed to send message with file', e);
                    alert('Failed to send message. Please try again.');
                });
                return;
            }
            
            // Regular message via SignalR
            var promise;
            if (typeof window.qmsChat === 'undefined') {
                console.error('Chat not initialized');
                // Fallback to REST API
                fetch('/api/ChatApi/messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ threadId: currentThreadId, content: text })
                }).then(function(r) { return r.json(); })
                .then(function(msg) {
                    if (msg && msg.id) {
                        var bubble = createMessageBubble(msg, true);
                        messagesEl.appendChild(bubble);
                        scrollToBottom();
                        refreshConversationList(); // Update conversation list
                    }
                    chatInput.value = '';
                    chatInput.style.height = 'auto';
                }).catch(function(e) {
                    console.error('Failed to send message', e);
                });
                return;
            }
            
            if (mode === 'department') {
                promise = window.qmsChat.sendToDepartment(targetId, text);
            } else if (mode === 'direct') {
                promise = window.qmsChat.sendToUser(targetId, text);
            } else {
                return;
            }
            
            promise.then(function() {
                chatInput.value = '';
                chatInput.style.height = 'auto';
                refreshConversationList(); // Update conversation list after send
            }).catch(function(e) {
                console.error('Failed to send message', e);
                alert('Failed to send message. Please try again.');
            });
        });
        
        // Listen for incoming messages
                if (typeof window.qmsChat !== 'undefined') {
            window.qmsChat.onReceiveMessage(function(msg) {
                // Refresh conversation list to show new message (move to top like Instagram)
                refreshConversationList();
                
                if (currentThreadId && msg.threadId === currentThreadId) {
                    var isOwn = msg.senderId && String(msg.senderId).toLowerCase() === currentUserId.toLowerCase();
                    // Avoid duplicates
                    if (!messagesEl.querySelector('[data-message-id="' + msg.id + '"]')) {
                        var bubble = createMessageBubble(msg, isOwn);
                        messagesEl.appendChild(bubble);
                        scrollToBottom();
                    }
                }
            });
        }
        
        // Also refresh when notification hub sends NewMessage event
        if (typeof window.notificationsHub !== 'undefined') {
            window.notificationsHub.on('NewMessage', function() {
                refreshConversationList();
            });
        }
        
        // New Chat Modal
        document.getElementById('btn-new-chat').addEventListener('click', function() {
            newChatModal.classList.remove('hidden');
        });
        
        document.getElementById('close-modal').addEventListener('click', function() {
            newChatModal.classList.add('hidden');
        });
        
        document.getElementById('modal-backdrop').addEventListener('click', function() {
            newChatModal.classList.add('hidden');
        });
        
        // Search contacts
        document.getElementById('search-contacts').addEventListener('input', function() {
            var query = this.value.toLowerCase();
            document.querySelectorAll('.modal-contact-btn').forEach(function(btn) {
                var name = btn.getAttribute('data-name').toLowerCase();
                btn.style.display = name.includes(query) ? 'block' : 'none';
            });
        });
        
        // Modal contact click
        document.querySelectorAll('.modal-contact-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var id = this.getAttribute('data-id');
                var name = this.getAttribute('data-name');
                newChatModal.classList.add('hidden');
                openConversation('direct', id, name);
            });
        });
        
        // Modal department chat
        var modalDeptSelect = document.getElementById('modal-dept-select');
        var modalStartDeptBtn = document.getElementById('modal-start-dept-chat');
        if (modalDeptSelect && modalStartDeptBtn) {
            modalDeptSelect.addEventListener('change', function() {
                modalStartDeptBtn.disabled = !this.value;
            });
            modalStartDeptBtn.addEventListener('click', function() {
                var id = modalDeptSelect.value;
                var name = modalDeptSelect.options[modalDeptSelect.selectedIndex].getAttribute('data-name');
                if (id && name) {
                    newChatModal.classList.add('hidden');
                    openConversation('department', id, name);
                }
            });
        }
        
        // Enter to send (Shift+Enter for new line)
        chatInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                chatForm.dispatchEvent(new Event('submit'));
            }
        });
        
        // Auto-open conversation from URL parameter (from notification)
        setTimeout(function() {
            if (autoOpenThreadId || autoOpenUserId) {
                if (autoOpenThreadType === 'Department' && autoOpenThreadId) {
                    openConversation('department', autoOpenThreadId, autoOpenUserName || 'Department');
                } else if (autoOpenUserId) {
                    openConversation('direct', autoOpenUserId, autoOpenUserName || 'Contact');
                } else if (autoOpenThreadId) {
                    // Try to open thread directly - need to fetch its details
                    fetch('/api/ChatApi/threads/' + autoOpenThreadId + '/messages')
                        .then(function(r) { return r.json(); })
                        .then(function(messages) {
                            if (messages && messages.length) {
                                currentThreadId = autoOpenThreadId;
                                chatModeEl.value = 'direct';
                                chatTargetEl.value = '';
                                
                                conversationHeader.innerHTML = '<h3 class="font-semibold text-slate-800">' + (autoOpenUserName || 'Conversation') + '</h3>' +
                                    '<p class="text-sm text-slate-500">Direct message</p>';
                                
                                messagesEl.innerHTML = '';
                                messages.forEach(function(msg) {
                                    var bubble = createMessageBubble(msg, msg.senderId === currentUserId);
                                    messagesEl.appendChild(bubble);
                                });
                                scrollToBottom();
                                
                                chatInputArea.style.display = 'block';
                                welcomePanel.style.display = 'none';
                            }
                        });
                }
                
                // Clear the URL parameters without refreshing
                if (history.replaceState) {
                    history.replaceState(null, '', window.location.pathname);
                }
            }
        }, 500);
        
        // Decrement message badge when viewing chat
        if (window.qmsBadges) {
            window.qmsBadges.setBadge('messages', 0);
        }
        })();
    </script>
}
