@page "{id:Guid}"
@model KasahQMS.Web.Pages.Chat.ThreadModel
@{
    ViewData["Title"] = Model.ThreadTitle ?? "Chat";
}

<div class="mx-auto max-w-4xl space-y-4">
    <nav class="flex items-center gap-2 text-sm text-slate-500">
        <a href="/Chat" class="hover:text-slate-900">Chat</a>
        <span>/</span>
        <span class="text-slate-700">@(Model.ThreadTitle ?? "Thread")</span>
    </nav>

    @if (!Model.CanAccess)
    {
        <div class="rounded-xl border border-amber-200 bg-amber-50 p-6 text-center">
            <p class="text-amber-800">You cannot access this chat thread.</p>
            <a href="/Chat" class="mt-3 inline-block text-sm font-medium text-amber-700 hover:underline">Back to Chat</a>
        </div>
    }
    else
    {
    <div class="rounded-xl border border-slate-200 bg-white shadow-sm overflow-hidden">
        <div class="border-b border-slate-200 bg-slate-50 px-4 py-3">
            <h1 class="text-lg font-semibold text-slate-900">@(Model.ThreadTitle ?? "Direct chat")</h1>
            <p class="text-sm text-slate-500">@(Model.TaskId.HasValue ? "Task-related conversation." : "Private conversation.")</p>
        </div>
        <div id="thread-messages" class="h-96 overflow-y-auto p-4 space-y-3 bg-slate-50/50"></div>
        <div class="border-t border-slate-200 p-4">
            <form id="thread-chat-form" class="flex gap-2">
                <input type="hidden" id="thread-id" value="@Model.ThreadId" />
                <input type="text" id="thread-input" placeholder="Type a message..." autocomplete="off"
                    class="flex-1 rounded-lg border border-slate-300 px-4 py-2 focus:ring-2 focus:ring-brand-500 focus:border-brand-500" />
                <button type="submit" id="thread-send" class="rounded-lg bg-brand-600 px-4 py-2 font-medium text-white hover:bg-brand-700">Send</button>
            </form>
        </div>
    </div>
    }
</div>

@section Scripts {
    <script src="~/js/signalr-chat.js"></script>
    <script>
        (function() {
            var threadIdEl = document.getElementById('thread-id');
            if (!threadIdEl) return;
            var threadId = threadIdEl.value;
            if (!threadId) return;
            var messagesEl = document.getElementById('thread-messages');
            var form = document.getElementById('thread-chat-form');
            var input = document.getElementById('thread-input');
            var sendBtn = document.getElementById('thread-send');

            function appendMessage(msg, isOwn) {
                var div = document.createElement('div');
                div.className = 'flex ' + (isOwn ? 'justify-end' : 'justify-start');
                var bubble = document.createElement('div');
                bubble.className = 'max-w-[75%] rounded-xl px-4 py-2 ' + (isOwn ? 'bg-brand-600 text-white' : 'bg-white border border-slate-200 text-slate-900');
                var name = document.createElement('div');
                name.className = 'text-xs font-medium opacity-80';
                name.textContent = msg.senderName || 'Someone';
                var text = document.createElement('div');
                text.className = 'text-sm mt-0.5';
                text.textContent = msg.content || '';
                var time = document.createElement('div');
                time.className = 'text-xs mt-1 opacity-70';
                time.textContent = msg.createdAt ? new Date(msg.createdAt).toLocaleTimeString() : '';
                bubble.appendChild(name);
                bubble.appendChild(text);
                bubble.appendChild(time);
                div.appendChild(bubble);
                messagesEl.appendChild(div);
                messagesEl.scrollTop = messagesEl.scrollHeight;
            }

            fetch('/api/ChatApi/messages?threadId=' + threadId + '&skip=0&take=100')
                .then(function(r) { return r.json(); })
                .then(function(list) {
                    if (!list || !Array.isArray(list)) return;
                    var uid = document.body.getAttribute('data-user-id');
                    var uid = (document.getElementById('user-context') || document.body).getAttribute('data-user-id');
                    list.forEach(function(m) {
                        appendMessage(m, uid && m.senderId && String(m.senderId).toLowerCase() === String(uid).toLowerCase());
                    });
                })
                .catch(function() {});

            if (typeof window.qmsChat !== 'undefined') {
                window.qmsChat.joinThread(threadId);
                window.qmsChat.onReceiveMessage(function(msg) {
                    if (!msg || String(msg.threadId) !== String(threadId)) return;
                    var uid = (document.getElementById('user-context') || document.body).getAttribute('data-user-id');
                    appendMessage(msg, uid && msg.senderId && String(msg.senderId).toLowerCase() === String(uid).toLowerCase());
                });
            }

            form.addEventListener('submit', function(e) {
                e.preventDefault();
                var text = (input.value || '').trim();
                if (!text) return;
                sendBtn.disabled = true;
                if (typeof window.qmsChat !== 'undefined') {
                    window.qmsChat.sendToThread(threadId, text).then(function() { input.value = ''; })
                        .catch(function() {}).finally(function() { sendBtn.disabled = false; });
                } else { sendBtn.disabled = false; }
            });
        })();
    </script>
}
